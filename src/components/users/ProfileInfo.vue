<script setup>
import { useAuthStore } from '../../stores/auth';
import { onMounted, reactive, computed, watch } from 'vue';
import { fetchUserInfo } from '../../utils/fetchUserInfo';
import axios from '@/axios';

const authStore = useAuthStore();

const connectButtonState = reactive({
    isConnection: false, // user is not a connection with logged user
    isPending: false, // connect request is pending
    buttonText: 'Conectar',
});

const connectButtonText = computed(() => {
    if (connectButtonState.isConnection) {
        return 'Chat';
    } else if (connectButtonState.isPending) {
        return 'Solicitud enviada';
    } else {
        return 'Conectar';
    }
});

watch(connectButtonText, (newText) => {
    connectButtonState.buttonText = newText;
});

const props = defineProps({
    username: String,
});

const userInfo = reactive({
    username: props.username,
    names: '',
    lastnames: '',
    career: '',
    description: '',
});

const sendConnectRequest = async () => {

    if (connectButtonState.isConnection || connectButtonState.isPending)
        return;

    try {
        const response = await axios.post(
            '/connect-api/send',
            {
                user_to_username: userInfo.username,
            },
            {
                headers: {
                    Authorization: `Token ${authStore.token}`,
                },
            }
        );

        if (response.status === 200) {
            connectButtonState.isPending = true;
        }
    } catch (error) {
        console.error('Error sending request: ', error);
    }
};

onMounted(async () => {
    try {
        const response = await fetchUserInfo(true, userInfo.username, authStore.token);
        const userData = response.data['user-info'];

        if (userData.middle_name) {
            userInfo.names = `${userData.first_name} ${userData.middle_name}`;
        } else {
            userInfo.names = userData.first_name;
        }

        if (userData.second_surname) {
            userInfo.lastnames = `${userData.last_name} ${userData.second_surname}`;
        } else {
            userInfo.lastnames = userData.last_name;
        }

        if (userData.career) {
            userInfo.career = userData.career;
        } else {
            userInfo.career = 'Sin carrera';
        }

        if (userData.personal_description) {
            userInfo.description = userData.personal_description;
        } else {
            userInfo.description = 'Sin descripción';
        }

    } catch (error) {
        console.error('Error fetching user info: ', error);
    }
});

</script>

<template>
    <div class="info-container">
        <div class="profile-photo"></div>

        <div class="names-info">
            <h3>{{ userInfo.username }}</h3>
            <h5>{{ userInfo.names }}</h5>
            <h5>{{ userInfo.lastnames }}</h5>
        </div>

        <h3 id="carrera">{{ userInfo.career }}</h3>

        <div class="bottom-container">
            <div class="description-container">
                <h5>Sobre mí</h5>
                <p id="description">{{ userInfo.description }}</p>
            </div>

            <button class="option-button" id="connect" @click="sendConnectRequest" :disabled="connectButtonState.isPending">
                {{ connectButtonState.buttonText }}
            </button>
        </div>

    </div>
</template>

<style scoped>
.info-container {
    background-color: #155C5F;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 50rem;
    height: 40rem;
    border-radius: 5%;
    flex-direction: column;
    color: white;
}

.profile-photo {
    margin-top: 2.5rem;
    width: 12rem;
    height: 12rem;
    border-radius: 50%;
    background-color: gray;
    order: -1;
}

.names-info {
    display: flex;
    flex-direction: column;
    margin-top: 1.5rem;
    justify-content: center;
    align-items: center;
}

#carrera {
    margin-top: 2rem;
    margin-left: 2rem;
    align-self: flex-start;
}

.bottom-container {
    display: flex;
    width: 45rem;
    height: 10rem;
    justify-content: space-between;
}

.description-container {
    display: flex;
    flex-direction: column;
}

.option-button {
    width: 5.5rem;
    height: 3.5rem;
    align-self: flex-end;
    border: none;
    border-radius: 7%;
}

.option-button:hover {
    font-size: 1.2rem;
    transition: 700ms;
}

#description {
    border-radius: 2%;
    height: auto;
    min-height: 4rem;
    max-height: 100%;
    overflow-y: auto;
}

#connect {
    background-color: #9ADB9A;
    margin-right: 2rem;
}

#connect:hover {
    background-color: #62BD62;
}
</style>